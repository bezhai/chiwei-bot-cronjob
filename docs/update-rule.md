# bangumi 数据更新规则

本项目的 bangumi 数据主要来源于 [Bangumi API](https://api.bgm.tv/)，采用分级更新策略，数据更新规则如下：

## 分级更新策略

### 1. 每日更新（每天6:00执行）

#### 增量更新
- 获取当前数据库中 type=2 的条目数量
- 获取线上 type=2 的条目数量进行对比
- 计算更新范围：从 `本地数量-50` 开始到 `线上数量` 结束（留50条buffer避免线上删库行为）
- 动画角色冷却周期：**3天**

#### 年度更新
- 更新当前年份和下一年份的所有 type=2 条目
- 通过 year 参数实现年份过滤
- 动画角色冷却周期：**3天**

### 2. 每周更新（每周日9:00执行）

- 更新前两年的条目（例如今年是2025年，则更新2023-2024年的条目）
- 动画角色冷却周期：**14天**

### 3. 月份轮询更新（每周一下午14:00执行）

- 采用月份轮询策略，将全量更新分散到13周内完成（1-12月 + 无月份）
- 使用Redis记录当前轮询月份，周而复始循环
- 有月份条目：使用 `/v0/subjects?month=X` API筛选
- 无月份条目：从本地数据库筛选，使用 `/v0/subjects/{id}` 单条目API更新
- 动画角色冷却周期：**60天**
- 一轮完整轮询周期：**13周（约一个季度）**

### 4. 季度全量刷新（每3个月1号11:00执行）

- 作为月份轮询的备用机制
- 使用 `/v0/subjects` 分页接口获取所有线上条目
- 对所有条目进行全量刷新和更新
- 动画角色冷却周期：**30-90天随机**

## 冷却周期说明

角色更新采用冷却机制，避免频繁更新同一角色：

- **每日更新**：3天冷却周期
- **每周更新**：14天冷却周期
- **月份轮询更新**：60天冷却周期
- **季度全量刷新**：30-90天动态冷却周期

## 定时任务配置

```typescript
// 每日6点：增量更新 + 当年和下一年更新
scheduleTask('0 6 * * *', 'daily incremental update', dailyIncrementalUpdate);
scheduleTask('0 7 * * *', 'yearly update', yearlyUpdate);

// 每周日9点：前两年条目更新
scheduleTask('0 9 * * 0', 'biweekly update', biweeklyUpdate);

// 每周一下午2点：月份轮询更新
scheduleTask('0 14 * * 1', 'monthly rotation update', monthlyRotationUpdate);
```

## 月份轮询详细说明

月份轮询更新将原来的月度全量刷新优化为分散式更新：

### 轮询周期
- **13个轮询单位**：1月、2月、3月...12月、无月份
- **轮询频率**：每周一次
- **完整周期**：13周（约一个季度）

### 更新策略
1. **有月份条目**（1-12月）：
   - 使用 `GET /v0/subjects?type=2&month=X` API筛选
   - 批量获取该月份的所有条目
   - 直接更新条目元数据和角色信息

2. **无月份条目**（month=0）：
   - 从本地数据库筛选 `date` 字段为空、null或格式无效的条目
   - 使用 `GET /v0/subjects/{id}` 单条目API逐个更新
   - 严格遵守1 QPS限制

### Redis状态管理
- **键名**：`bangumi:monthly_rotation:current_month`
- **值范围**：0-12（0表示无月份，1-12表示对应月份）
- **自动轮询**：每次执行后自动切换到下一个月份
